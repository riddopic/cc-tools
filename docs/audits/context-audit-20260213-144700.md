# Context Audit: cc-tools

**Date:** 2026-02-13T14:47:00+08:00
**Scope:** /Users/riddopic/git/cc-stuff/q2 (entire Go codebase)

---

## Module Map

### Project Identity

| Field | Value |
|-------|-------|
| Module (go.mod) | `github.com/riddopic/cc-tools` |
| Module (imports) | `github.com/riddopic/cc-tools` **MISMATCH** |
| Go Version | 1.24 |
| Key Dependencies | charmbracelet/bubbles, charmbracelet/lipgloss, mattn/go-runewidth |

### CLI Entry Points (3 binaries)

| Binary | Path | Purpose |
|--------|------|---------|
| `cc-tools` | `cmd/cc-tools/main.go` | Main CLI with subcommands: statusline, validate, skip, unskip, debug, mcp, config, version |
| `cc-tools-statusline` | `cmd/cc-tools-statusline/main.go` | Standalone statusline binary (duplicates main CLI logic) |
| `cc-tools-validate` | `cmd/cc-tools-validate/main.go` | Standalone validate binary (duplicates main CLI logic) |

### Internal Packages (8)

| Package | Files | Purpose |
|---------|-------|---------|
| `internal/config` | config.go, manager.go | Dual config system: flat Load() + structured Manager |
| `internal/debug` | config.go, logger.go | Per-directory debug toggle with file-based logging |
| `internal/hooks` | 7 source + 4 test files | Hook validation, command discovery, locking, execution |
| `internal/mcp` | mcp.go | MCP server enable/disable via `claude` CLI |
| `internal/output` | output.go, hook.go, table.go | Terminal output with lipgloss + raw ANSI for hooks |
| `internal/shared` | colors.go, project.go, debug_paths.go, dependencies.go | Colors, project detection, filesystem abstractions |
| `internal/skipregistry` | interfaces.go, types.go, registry.go, storage.go | Skip lint/test per directory, JSON-backed, thread-safe |
| `internal/statusline` | 7 source + 8 test files | Powerline-style statusline with context bar |

### Actors

| Actor | Role | Trust Level |
|-------|------|-------------|
| User | CLI operator | Trusted |
| Claude Code | Automated hook caller via stdin JSON | Semi-trusted |
| `claude` CLI | External dependency for MCP management | Trusted |
| File System | Config, registry, debug logs, transcript | Trusted (user-owned) |
| Subprocesses | make, golangci-lint, go test, cargo, etc. | Trusted (discovered from project) |

### Key State Locations

| State | Path | Purpose |
|-------|------|---------|
| App config | `~/.config/cc-tools/config.json` | Timeout, cooldown, cache settings |
| Debug config | `~/.claude/debug-config.json` | Per-directory debug enable/disable |
| Skip registry | `~/.claude/skip-registry.json` | Directories that skip lint/test |
| MCP settings | `~/.claude/settings.json` | MCP server definitions (read-only) |
| Debug logs | `/tmp/cc-tools-*.debug` | Hook execution traces |
| Lock files | `/tmp/claude-hook-*.lock` | Cross-process lock coordination |

---

## Function Micro-Analyses

### hooks/lock.go — LockManager

**TryAcquire()** (line 73)

- **Purpose:** Atomic cross-process lock acquisition
- **Mechanism:** O_EXCL file creation, then stale lock check with process existence + cooldown
- **Correctness:** Proper TOCTOU mitigation via retry-after-remove pattern
- **Issue:** ProcessExists uses `process.Signal(nil)` which is NOT equivalent to Unix signal 0 — see Fragility Cluster 6

**Release()** (line 121)

- **Purpose:** Release lock with cooldown timestamp
- **Mechanism:** Overwrites lock file with empty PID + current Unix timestamp
- **Note:** Lock file persists after release (intentional for cooldown)

### hooks/executor.go — RunSmartHook

**RunSmartHook()** (line 211)

- **Purpose:** Main entry point for PostToolUse lint/test hooks
- **Flow:** init logger → read input → validate event → skip check → find project root → acquire lock → discover command → execute → release lock
- **Correctness:** Proper defer for logger close and lock release
- **Note:** Returns 0 (success) on all error paths — hooks silently fail rather than blocking

**ExecuteForHook()** (line 112)

- **Purpose:** Execute command and format result for Claude Code hook response
- **Exit codes:** 0 = silent pass, 2 = show message to Claude
- **Note:** Both success and failure use exit code 2 (show message)

### hooks/discovery.go — CommandDiscovery

**DiscoverCommand()** (line 50)

- **Purpose:** Walk up directory tree discovering lint/test commands
- **Search order:** Taskfile.yml → justfile → package.json → scripts/ → language-specific
- **Note:** Uses timeouts for each probe command (task --list, just --show, jq)
- **Edge case:** If projectRoot == startDir, only checks one directory (correct behavior)

### hooks/validate.go — ParallelValidateExecutor

**ExecuteValidations()** (line 113)

- **Purpose:** Run lint + test in parallel with skip support
- **Concurrency:** Uses sync.WaitGroup with goroutines per command
- **Race condition risk:** Low — result fields (LintResult, TestResult) are written by different goroutines with no overlap

**FormatMessage()** (line 42)

- **Purpose:** Format validation results for Claude Code display
- **Issue:** If both lint and test fail, accesses `vr.LintResult.Command` and `vr.TestResult.Command` without nil checks on `.Command` (line 56-57). If discovery failed but execution returned a result, this could panic.

### hooks/validate_skip.go — ValidateWithSkipCheck

**ValidateWithSkipCheck()** (line 16)

- **Purpose:** Entry point for validate with skip registry integration
- **Issue:** Creates `NewDefaultDependencies()` three times (line 55-57) — should call once

### statusline/statusline.go — Statusline

**Generate()** (line 176)

- **Purpose:** Parse stdin JSON and render statusline
- **Flow:** parseInput → getCurrentDir → computeData → Render
- **Note:** Comment says "no caching" but CachedData type exists (historical artifact)

**getTokenMetrics()** (line 368)

- **Purpose:** Parse JSONL transcript for token usage
- **Issue:** Reads entire transcript file into memory, splits by newlines, parses each line as JSON
- **Performance risk:** Unbounded file size; long sessions produce large transcripts
- **Logic:** Tracks most recent main chain entry (not sidechain, not API error) for context length

**getGitInfo()** (line 270)

- **Purpose:** Read git branch from .git/HEAD file directly (no subprocess)
- **Correctness:** Handles worktrees (.git as file with gitdir: reference)
- **Status heuristic:** Uses git index modification time < 60s as proxy for uncommitted changes — approximate but avoids subprocess cost

### statusline/render.go — Render

**Render()** (line 13)

- **Purpose:** Build powerline-style statusline with ANSI colors
- **Structure:** leftSection (dir + model) → middleSection (context bar or spaces) → rightSection (components)
- **Complexity:** 7 DEBUG_WIDTH checks scattered through rendering pipeline
- **Width management:** terminal width - left spacer - right spacer = effective width, then budgeted across sections

**selectModelIcon()** (line 645)

- **Purpose:** Random model icon for statusline
- **Note:** Changes every render — potentially distracting

### config/manager.go — Manager

- **Dual loading:** Tries structured parse first, falls back to flat map
- **Thread safety:** sync.RWMutex for concurrent access
- **Values:** validate timeout (30s default), cooldown (60s default), cache dir (/dev/shm default), cache duration (2s default)

### mcp/mcp.go — Manager

**findMCPByName()** (line 85)

- **Purpose:** Fuzzy match MCP server names
- **Issue:** Hardcoded "targetprocess" → "target"/"target-process" mapping. Partial match via Contains could produce false positives with many MCP servers.

**Enable()** (line 129)

- **Purpose:** Add MCP server via `claude mcp add`
- **Note:** Expands `~/` in command paths. Handles "already exists" gracefully.

---

## Global Understanding

### State & Invariants

| ID | Invariant | Status | Location |
|----|-----------|--------|----------|
| I1 | Module path in go.mod matches all import paths | **BROKEN** | go.mod vs all .go files |
| I2 | Lock files ensure single hook instance per workspace+type | OK | hooks/lock.go |
| I3 | Skip registry atomic write with cache rollback on failure | OK | skipregistry/registry.go |
| I4 | Debug logger/config thread-safe via mutex | OK | debug/config.go, debug/logger.go |
| I5 | Validate result correctly reflects parallel execution outcome | OK (with caveat) | hooks/validate.go |

### Workflows

| Workflow | Trigger | Key Steps | Exit |
|----------|---------|-----------|------|
| Smart Hook | PostToolUse (Edit/Write) | parse stdin → skip check → lock → discover → execute | exit 0 or 2 |
| Validate Hook | PostToolUse (Edit/Write) | parse stdin → skip registry → lock → parallel lint+test → format | exit 0 or 2 |
| Statusline | Statusline prompt | parse stdin → compute git/k8s/tokens → render powerline | stdout string |
| Skip Toggle | CLI `skip`/`unskip` | parse args → update registry → confirm | stdout message |
| Debug Toggle | CLI `debug enable/disable` | parse args → update config → confirm | stdout message |
| MCP Management | CLI `mcp` subcommands | load settings → shell out to `claude mcp` | stdout message |
| Config Management | CLI `config` subcommands | ensure config file → get/set/list/reset | stdout message |

### Trust Boundaries

```
                    ┌──────────────────────────────────┐
                    │        Claude Code (caller)       │
                    │    Provides JSON on stdin         │
                    └───────────┬──────────────────────┘
                                │ stdin JSON
                    ┌───────────▼──────────────────────┐
                    │         cc-tools CLI              │
                    │  ┌─────────────────────────────┐  │
                    │  │  JSON parser (graceful fail) │  │
                    │  └────────┬────────────────────┘  │
                    │           │                        │
                    │  ┌────────▼────────────────────┐  │
                    │  │ File System (trusted reads)  │  │
                    │  │ ~/.claude/*.json             │  │
                    │  │ ~/.config/cc-tools/*.json    │  │
                    │  │ /tmp/claude-hook-*.lock      │  │
                    │  └────────┬────────────────────┘  │
                    │           │                        │
                    │  ┌────────▼────────────────────┐  │
                    │  │ Subprocess Execution         │  │
                    │  │ (exec.Command, no shell)     │  │
                    │  │ make, golangci-lint, go,     │  │
                    │  │ cargo, pytest, claude        │  │
                    │  └────────────────────────────┘  │
                    └──────────────────────────────────┘
```

### Fragility Clusters

#### Cluster 1: Module Path Mismatch (CRITICAL)

- **Severity:** P0 — prevents compilation
- **Files:** go.mod (line 1), all .go files with imports
- **Impact:** `go build` will fail with "package not found" errors
- **Fix:** Update go.mod to `module github.com/riddopic/cc-tools` OR update all imports to `github.com/riddopic/cc-tools`

#### Cluster 2: Code Duplication (HIGH)

- **Severity:** P1 — maintenance burden, drift risk
- **Files:** cmd/cc-tools/main.go, cmd/cc-tools-statusline/main.go, cmd/cc-tools-validate/main.go
- **Duplicated functions:** `runStatuslineWithInput()`, `getCacheDir()`, `getCacheDuration()`, `loadValidateConfig()`
- **Fix:** Extract shared code to internal package; have standalone binaries import it

#### Cluster 3: Triple FileSystem Interface (MEDIUM)

- **Severity:** P2 — violates project's own rules
- **Files:** internal/shared/dependencies.go, internal/hooks/dependencies.go, internal/skipregistry/interfaces.go
- **Impact:** 3 different FileSystem interfaces with different method sets
- **Fix:** Unify into single interface in internal/shared or dedicated interfaces package

#### Cluster 4: Signal(nil) Bug (HIGH)

- **Severity:** P1 — potential runtime panic
- **File:** internal/hooks/dependencies.go:197
- **Code:** `process.Signal(os.Signal(nil))` — should be `process.Signal(syscall.Signal(0))`
- **Impact:** ProcessExists may panic or return incorrect results

#### Cluster 5: Unbounded Transcript Parsing (MEDIUM)

- **Severity:** P2 — performance degradation
- **File:** internal/statusline/statusline.go:368-435
- **Impact:** Reads entire transcript file into memory; no size limit
- **Fix:** Read from end of file, or use streaming parser with early termination

#### Cluster 6: Debug Code in Production (LOW)

- **Severity:** P3 — code quality
- **Files:** render.go (7x DEBUG_WIDTH), statusline.go (1x DEBUG_CONTEXT writing to /tmp)
- **Impact:** Debug env var checks on every render; /tmp file writes
- **Fix:** Use structured logging via debug package, or remove

#### Cluster 7: os.Exit in Library Code (MEDIUM)

- **Severity:** P2 — testability, error handling
- **File:** internal/output/output.go:87,98,130,138
- **Impact:** `os.Exit(1)` on write failure prevents graceful error handling
- **Fix:** Return errors or accept configurable exit function

#### Cluster 8: Color/Style Duplication (LOW)

- **Severity:** P3 — maintenance burden
- **Files:** shared/colors.go, output/hook.go, output/output.go, statusline/colors.go
- **Impact:** Same ANSI codes and lipgloss colors defined in multiple places
- **Fix:** Centralize in shared/colors.go

#### Cluster 9: Duplicate Project Detection (LOW)

- **Severity:** P3 — inconsistency risk
- **Files:** shared/project.go:DetectProjectType(), hooks/discovery.go:detectProjectTypes()
- **Impact:** Different detection logic (shared includes nix, hooks doesn't)
- **Fix:** Have hooks/discovery.go delegate to shared

---

## Open Questions

1. **Module path mismatch origin:** Was this forked from `riddopic/cc-tools` with go.mod updated but not imports? Or the reverse? This must be resolved before any compilation is possible.

2. **Standalone binaries necessity:** Are `cc-tools-statusline` and `cc-tools-validate` required as separate binaries, or can Claude Code be configured to use `cc-tools statusline` and `cc-tools validate` subcommands instead?

3. **Transcript file size bounds:** Is there a maximum transcript size? Long Claude Code sessions could produce multi-MB transcript files that the statusline parser reads entirely into memory on every prompt render.

4. **`/dev/shm` cache directory default:** The default cache directory is `/dev/shm` which doesn't exist on macOS. The code has fallback logic, but this default seems Linux-specific for a tool that clearly runs on macOS.

5. **`process.Signal(nil)` behavior:** Does this actually work correctly on the target platform (macOS/Darwin)? The Go documentation doesn't specify behavior for nil signals. This should be verified or replaced with `syscall.Signal(0)`.

6. **Random model icon UX:** The model icon changes randomly on every statusline render. Is this intentional design, or should it be deterministic (e.g., based on model ID hash)?

7. **Orphaned benchmark example:** `docs/examples/benchmark/basic_usage.go` imports from `github.com/riddopic/quanta` — a different project entirely. Should this file be removed?

8. **Dual config loading systems:** `internal/config/config.go` Load() and `internal/config/manager.go` Manager both read the same file with different parsing strategies. Which is canonical?
